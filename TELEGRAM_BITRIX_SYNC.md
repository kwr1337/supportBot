# Новая система связывания Telegram с Bitrix24

## Обзор изменений

Система была модернизирована для автоматического определения сотрудников через поле `tgID` в Bitrix24, вместо ручного добавления к проектам.

## Основные изменения

### 1. Убрано добавление сотрудников к проектам
- **Раньше:** Нужно было добавлять каждого сотрудника к конкретному проекту/чату
- **Теперь:** Сотрудники определяются автоматически по полю `tgID` в Bitrix24

### 2. Новая логика назначения исполнителя задач
- **Если у создателя задачи есть `tgID` в Bitrix24** → исполнитель = сам создатель
- **Если нет `tgID`** → исполнитель = ТехАккаунт (ID: 1269)

### 3. Автоматическое связывание
- При запуске бота загружается кеш всех пользователей с заполненным `tgID`
- Система автоматически определяет, является ли пользователь сотрудником

## Новые команды администратора

### `/show_links` - Показать все связи
Отображает все активные связи между Telegram ID и Bitrix24 пользователями.

### `/link_telegram <Bitrix24_ID> <Telegram_ID>` - Связать аккаунты
Создает связь между Bitrix24 пользователем и Telegram аккаунтом.
```
Пример: /link_telegram 123 608167496
```

### `/unlink_telegram <Telegram_ID>` - Удалить связь
Удаляет связь Telegram аккаунта с Bitrix24.
```
Пример: /unlink_telegram 608167496
```

### `/sync_bitrix` - Синхронизация
Обновляет кеш связей из Bitrix24 и синхронизирует с локальной базой данных.

## Работа с полем tgID в Bitrix24

### Возможные названия поля
Система проверяет следующие варианты названий поля в Bitrix24:
- `UF_TELEGRAM_ID`
- `UF_TG_ID` 
- `UF_TGID`
- `tgID`

### Заполнение поля
1. **Автоматически** - через команду `/link_telegram`
2. **Вручную** - в интерфейсе Bitrix24

## Алгоритм работы

### При создании задачи:
1. Получаем Telegram ID создателя
2. Ищем соответствующий Bitrix24 ID в кеше
3. Если найден → назначаем исполнителем сотрудника
4. Если не найден → назначаем ТехАккаунт

### Кеширование:
- При запуске бота загружается кеш из Bitrix24
- Кеш обновляется при добавлении/удалении связей
- Команда `/sync_bitrix` принудительно обновляет кеш

## Миграция существующих данных

### Для существующих сотрудников:
1. Запустите `/show_links` для просмотра текущих связей
2. Используйте `/link_telegram` для связывания несвязанных сотрудников
3. Проверьте поля `tgID` в Bitrix24

### Автоматическая миграция:
- Команда `/sync_bitrix` автоматически синхронизирует существующие записи
- Локальная база данных `BotUser` обновляется автоматически

## Преимущества новой системы

1. **Упрощение настройки** - не нужно добавлять сотрудников к каждому проекту
2. **Автоматическое определение** - система сама понимает, кто сотрудник
3. **Единый источник истины** - Bitrix24 как основной источник данных о сотрудниках
4. **Масштабируемость** - легко добавлять новых сотрудников

## Обратная совместимость

- Старые команды управления сотрудниками остались для совместимости
- Существующие записи в локальной БД сохраняются
- Система сначала проверяет новый механизм, затем fallback на старый

## Логирование

Все операции связывания логируются:
- Успешные связывания
- Ошибки поиска в Bitrix24  
- Обновления кеша
- Назначение исполнителей задач

## Устранение неполадок

### Если сотрудник не определяется:
1. Проверьте поле `tgID` в Bitrix24
2. Запустите `/sync_bitrix`
3. Используйте `/link_telegram` для ручного связывания

### Если команды не работают:
1. Убедитесь, что у вас права администратора
2. Проверьте подключение к Bitrix24
3. Посмотрите логи бота

### Проверка состояния:
- `/show_links` - показывает все связи
- `/sync_bitrix` - обновляет данные
- Логи содержат детальную информацию о процессе
